@using System.Text.Json
@using FilesToData.Shared.Models

<div class="job-detail">
    <div class="job-header">
        <div class="job-info">
            <h2>@(Job?.FileName ?? "Sin nombre")</h2>
            <span class="badge mode">@Job?.Mode</span>
            <span class="badge status @Job?.Status.ToString().ToLower()">@Job?.Status</span>
        </div>
        <div class="job-actions">
            <button class="btn btn-secondary" @onclick="OnRefresh">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <button class="btn btn-primary" @onclick="SaveChanges" disabled="@(!hasChanges)">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
        </div>
    </div>
    
    <div class="job-content">
        <div class="panel">
            <div class="panel-header">
                <h3>Resultados</h3>
            </div>
            <div class="panel-content">
                <textarea class="results-editor" 
                          @bind-value="resultsJson" 
                          @bind-value:event="oninput"
                          @bind-value:after="OnResultsAfterInput"
                          @onchange="OnResultsChanged"
                          placeholder="Los resultados aparecerán aquí..."></textarea>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <h3>Vista Previa</h3>
            </div>
            <div class="panel-content">
                @if (!string.IsNullOrWhiteSpace(previewError))
                {
                    <div class="preview-placeholder">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>@previewError</p>
                    </div>
                }
                else if (sewingPages.Count > 0)
                {
                    @foreach (var page in sewingPages)
                    {
                        <SewingWorksheetPreview Model="page.Model" PageNumber="page.PageNumber" RawText="page.RawText" />
                    }
                }
                else
                {
                    <div class="preview-placeholder">
                        <i class="fas fa-file"></i>
                        <p>@(Job?.FileName ?? "Archivo")</p>
                        <p style="font-size: 12px;">@Job?.Mode • @Job?.Status</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Job? Job { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }
    [Parameter] public EventCallback<object> OnSave { get; set; }

    private string resultsJson = "";
    private bool hasChanges;
    private string? previewError;
    private List<SewingPageVm> sewingPages = new();

    private readonly JsonSerializerOptions _jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    protected override void OnParametersSet()
    {
        if (Job?.Results != null)
        {
            resultsJson = JsonSerializer.Serialize(Job.Results, new JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        else if (Job?.Status == JobStatus.PROCESSING)
        {
            resultsJson = "Procesando...";
        }
        else if (Job?.Status == JobStatus.FAILED)
        {
            resultsJson = $"Error: {Job.ErrorMessage ?? "Error desconocido"}";
        }
        else
        {
            resultsJson = "Esperando resultados...";
        }
        
        hasChanges = false;
        UpdatePreview();
    }

    private void OnResultsChanged(ChangeEventArgs e)
    {
        hasChanges = true;
        UpdatePreview();
    }

    private void OnResultsAfterInput()
    {
        hasChanges = true;
        UpdatePreview();
    }

    private void UpdatePreview()
    {
        previewError = null;
        sewingPages = new List<SewingPageVm>();

        if (string.IsNullOrWhiteSpace(resultsJson))
            return;

        try
        {
            var doc = JsonSerializer.Deserialize<AiDocumentResult>(resultsJson, _jsonOptions);
            if (doc?.Pages == null || doc.Pages.Count == 0)
                return;

            foreach (var page in doc.Pages)
            {
                var template = page.Data.Deserialize<AiTemplatePageData>(_jsonOptions);
                if (template?.TemplateType == "sewing_worksheet" && template.SewingWorksheet != null)
                {
                    Normalize(template.SewingWorksheet);

                    sewingPages.Add(new SewingPageVm
                    {
                        PageNumber = page.PageNumber,
                        RawText = page.RawText,
                        Model = template.SewingWorksheet
                    });
                    continue;
                }

                if (LooksLikeLegacySewingHeader(page.Data))
                {
                    var header = page.Data.Deserialize<SewingWorksheetHeader>(_jsonOptions) ?? new SewingWorksheetHeader();
                    var model = new SewingWorksheetModel
                    {
                        Header = header,
                        OrderInfo = new SewingWorksheetOrderInfo(),
                        FabricInfo = new SewingWorksheetFabricInfo(),
                        QuantityLines = new List<QuantityLine>(),
                        OrderProcedureNotes = new List<string>(),
                        CuttingDetailNotes = new List<string>(),
                        SewingDetailNotes = new List<string>(),
                        TrimPackingNotes = new List<string>(),
                        MeasurementRows = new List<MeasurementRow>()
                    };

                    sewingPages.Add(new SewingPageVm
                    {
                        PageNumber = page.PageNumber,
                        RawText = page.RawText,
                        Model = model
                    });
                }
            }
        }
        catch (Exception ex)
        {
            previewError = ex.Message;
        }
    }

    private static bool LooksLikeLegacySewingHeader(JsonElement element)
    {
        if (element.ValueKind != JsonValueKind.Object)
            return false;

        return element.TryGetProperty("contact", out _)
            || element.TryGetProperty("revised_date", out _)
            || element.TryGetProperty("requested_by", out _)
            || element.TryGetProperty("work_plant", out _)
            || element.TryGetProperty("document_date", out _);
    }

    private static void Normalize(SewingWorksheetModel model)
    {
        model.Header ??= new SewingWorksheetHeader();
        model.OrderInfo ??= new SewingWorksheetOrderInfo();
        model.FabricInfo ??= new SewingWorksheetFabricInfo();
        model.QuantityLines ??= new List<QuantityLine>();
        model.MeasurementRows ??= new List<MeasurementRow>();
        model.OrderProcedureNotes ??= new List<string>();
        model.CuttingDetailNotes ??= new List<string>();
        model.SewingDetailNotes ??= new List<string>();
        model.TrimPackingNotes ??= new List<string>();

        foreach (var q in model.QuantityLines)
        {
            q.Sizes ??= new SizeBreakdown();
        }
    }

    private class SewingPageVm
    {
        public int PageNumber { get; set; }
        public string? RawText { get; set; }
        public SewingWorksheetModel Model { get; set; } = new();
    }

    private async Task SaveChanges()
    {
        try
        {
            var data = JsonSerializer.Deserialize<object>(resultsJson);
            await OnSave.InvokeAsync(data);
            hasChanges = false;
        }
        catch (JsonException)
        {
            // Invalid JSON - could show error
        }
    }
}
