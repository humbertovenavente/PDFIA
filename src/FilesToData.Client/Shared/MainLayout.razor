@inherits LayoutComponentBase

<div class="main-layout">
    <Sidebar @ref="sidebar" 
             Jobs="@jobs" 
             SelectedJobId="@selectedJobId"
             OnNewJob="ShowUpload"
             OnJobSelected="SelectJob" />
    
    <div class="main-content">
        <header class="main-header">
            <button class="btn-toggle" @onclick="ToggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="header-title">FilesToData v2.7</h1>
            <span class="status-indicator">
                <i class="fas fa-circle"></i>
                <span>Conectado</span>
            </span>
        </header>

        @Body
    </div>
</div>

@if (isLoading)
{
    <div class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>@loadingMessage</p>
        </div>
    </div>
}

@code {
    private Sidebar? sidebar;
    private List<Job> jobs = new();
    private Guid? selectedJobId;
    private bool isLoading;
    private string loadingMessage = "Procesando...";

    [Inject] private IJobService JobService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobs();
    }

    private async Task LoadJobs()
    {
        try
        {
            var response = await JobService.ListJobsAsync();
            jobs = response.Jobs;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading jobs: {ex.Message}");
        }
    }

    private void ToggleSidebar()
    {
        sidebar?.Toggle();
    }

    private void ShowUpload()
    {
        selectedJobId = null;
        Navigation.NavigateTo("/");
    }

    private void SelectJob(Guid jobId)
    {
        selectedJobId = jobId;
        Navigation.NavigateTo($"/job/{jobId}");
    }

    public void SetLoading(bool loading, string message = "Procesando...")
    {
        isLoading = loading;
        loadingMessage = message;
        StateHasChanged();
    }

    public async Task RefreshJobs()
    {
        await LoadJobs();
        StateHasChanged();
    }
}
